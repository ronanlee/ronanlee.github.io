<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>AWS Script for cloud | Wiki</title>
    <meta name="description" content="bash script">
    
    
    <link rel="preload" href="/assets/css/0.styles.8d474957.css" as="style"><link rel="preload" href="/assets/js/app.7ba35480.js" as="script"><link rel="preload" href="/assets/js/2.c7d13bc3.js" as="script"><link rel="preload" href="/assets/js/26.593cdeff.js" as="script"><link rel="prefetch" href="/assets/js/10.e387750b.js"><link rel="prefetch" href="/assets/js/11.fb028773.js"><link rel="prefetch" href="/assets/js/12.4e270f60.js"><link rel="prefetch" href="/assets/js/13.13b726fb.js"><link rel="prefetch" href="/assets/js/14.39393894.js"><link rel="prefetch" href="/assets/js/15.56a9d73b.js"><link rel="prefetch" href="/assets/js/16.0c72793c.js"><link rel="prefetch" href="/assets/js/17.cf66bf2b.js"><link rel="prefetch" href="/assets/js/18.c3db622d.js"><link rel="prefetch" href="/assets/js/19.ba6b3442.js"><link rel="prefetch" href="/assets/js/20.0b98850c.js"><link rel="prefetch" href="/assets/js/21.53cb63c3.js"><link rel="prefetch" href="/assets/js/22.85c5b289.js"><link rel="prefetch" href="/assets/js/23.f3a1b949.js"><link rel="prefetch" href="/assets/js/24.f906b4d3.js"><link rel="prefetch" href="/assets/js/25.dd73f9c7.js"><link rel="prefetch" href="/assets/js/27.b2ad6692.js"><link rel="prefetch" href="/assets/js/28.49350086.js"><link rel="prefetch" href="/assets/js/3.9d95cf26.js"><link rel="prefetch" href="/assets/js/4.03f328fe.js"><link rel="prefetch" href="/assets/js/5.1f27e92e.js"><link rel="prefetch" href="/assets/js/6.f0aa61d9.js"><link rel="prefetch" href="/assets/js/7.636866dc.js"><link rel="prefetch" href="/assets/js/8.11fb9961.js"><link rel="prefetch" href="/assets/js/9.bb28163e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8d474957.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Wiki</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/java/" class="nav-link">Java</a></div><div class="nav-item"><a href="/python/" class="nav-link router-link-active">Python</a></div><div class="nav-item"><a href="/aws/" class="nav-link">Aws</a></div><div class="nav-item"><a href="/spring/" class="nav-link">Spring</a></div><div class="nav-item"><a href="/angular/" class="nav-link">angular</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/java/" class="nav-link">Java</a></div><div class="nav-item"><a href="/python/" class="nav-link router-link-active">Python</a></div><div class="nav-item"><a href="/aws/" class="nav-link">Aws</a></div><div class="nav-item"><a href="/spring/" class="nav-link">Spring</a></div><div class="nav-item"><a href="/angular/" class="nav-link">angular</a></div> <!----></nav>  <!----> </div> <div class="page"> <div class="content default"><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token comment"># By installing the Amazon Discovery Agent, you agree that your use is</span>
<span class="token comment"># subject to the terms of your existing AWS Customer Agreement or other </span>
<span class="token comment"># agreement with Amazon Web Services, Inc. or its affiliates governing your </span>
<span class="token comment"># use of AWS services. You may not install and use the </span>
<span class="token comment"># Amazon Discovery Agent unless you have an account in good standing with AWS.</span>

<span class="token comment"># Copyright 2017 Amazon Web Services, Inc. or its affiliates. All Rights Reserved.</span>
<span class="token comment"># Licensed under the terms of your existing AWS Customer Agreement </span>
<span class="token comment"># &lt;https://aws.amazon.com/agreement/&gt; or other agreement with Amazon Web Services, Inc. </span>
<span class="token comment"># or its affiliates governing your use of AWS services.</span>
<span class="token comment">#</span>
<span class="token comment"># Discovery Agent installer script to get the proper package installed.</span>
<span class="token comment"># Version: 2.0.1129.0</span>

<span class="token comment"># For debugging, uncomment this line:</span>
<span class="token comment"># set -eux</span>

<span class="token keyword">function</span> exit_run_once <span class="token punctuation">{</span>
    local pidfile<span class="token operator">=</span><span class="token variable">${1}</span>
    local exitcode<span class="token operator">=</span><span class="token variable">${2}</span>

    <span class="token function">rm</span> -f <span class="token variable">$pidfile</span>
    <span class="token keyword">exit</span> <span class="token variable">$exitcode</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> init_run_once <span class="token punctuation">{</span>
    local pidfile<span class="token operator">=</span><span class="token variable">${1}</span>
    local pid_creation_code<span class="token operator">=</span>1
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> -f <span class="token variable">$pidfile</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        local pid<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> $pidfile<span class="token variable">)</span></span>
        <span class="token function">ps</span> -p <span class="token variable">$pid</span> <span class="token operator">&gt;</span> /dev/null 2<span class="token operator">&gt;</span><span class="token operator">&amp;</span>1
        <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$?</span> -eq 0 <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
            <span class="token keyword">echo</span> <span class="token string">&quot;Script <span class="token variable">$0</span> is already running. Will retry at next cron interval.&quot;</span>
            <span class="token keyword">exit</span> 1
        <span class="token keyword">else</span> <span class="token comment"># assume stale pidfile</span>
            <span class="token keyword">echo</span> $$ <span class="token operator">&gt;</span> <span class="token variable">$pidfile</span>
            pid_creation_code<span class="token operator">=</span><span class="token variable">$?</span>
        <span class="token keyword">fi</span>
    <span class="token keyword">else</span> <span class="token comment"># There a theoretical race condition right here, but our cron does not spawn twice within a fractional second or even a minute, ever.</span>
        <span class="token keyword">echo</span> $$ <span class="token operator">&gt;</span> <span class="token variable">$pidfile</span>
        pid_creation_code<span class="token operator">=</span><span class="token variable">$?</span>
    <span class="token keyword">fi</span>

    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$pid_creation_code</span> -ne 0 <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;Could not create PID file: <span class="token variable">$pidfile</span>.&quot;</span>
        <span class="token keyword">exit</span> 1
    <span class="token keyword">fi</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> validate_boolean <span class="token punctuation">{</span>
    <span class="token comment"># Bash doesn't have booleans, so let's validate.</span>
    local str<span class="token operator">=</span><span class="token variable">${1}</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">${str}</span> <span class="token operator">==</span> <span class="token string">&quot;true&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">:</span>
    <span class="token keyword">elif</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">${str}</span> <span class="token operator">==</span> <span class="token string">&quot;false&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">:</span>
    <span class="token keyword">else</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;Invalid boolean value of <span class="token variable">${str}</span>&quot;</span>
        exit_run_once <span class="token variable">${PID_FILE}</span>  1
    <span class="token keyword">fi</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> determine_os_package_manager<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">hash</span> dpkg 2<span class="token operator">&gt;</span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span>
      PACKAGE_TYPE<span class="token operator">=</span><span class="token string">&quot;deb&quot;</span>
      OS_PACKAGE_MGR<span class="token operator">=</span><span class="token string">&quot;apt-get&quot;</span>
    <span class="token keyword">elif</span> <span class="token function">hash</span> yum 2<span class="token operator">&gt;</span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span>
      PACKAGE_TYPE<span class="token operator">=</span><span class="token string">&quot;rpm&quot;</span>
      OS_PACKAGE_MGR<span class="token operator">=</span><span class="token string">&quot;yum&quot;</span>
    <span class="token keyword">elif</span> <span class="token function">hash</span> rpm 2<span class="token operator">&gt;</span>/dev/null <span class="token operator">&amp;&amp;</span> <span class="token function">hash</span> zypper 2<span class="token operator">&gt;</span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span>
      PACKAGE_TYPE<span class="token operator">=</span><span class="token string">&quot;rpm&quot;</span>
      OS_PACKAGE_MGR<span class="token operator">=</span><span class="token string">&quot;zypper&quot;</span>
    <span class="token keyword">else</span>
      <span class="token keyword">echo</span> <span class="token string">&quot;No supported package managers are installed.&quot;</span>
      exit_run_once <span class="token variable">${PID_FILE}</span> 1
    <span class="token keyword">fi</span>
    <span class="token comment"># Check if 64 bit installation is requested by customer</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">${INSTALL_AGENT_ARCHITECTURE}</span>&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;64&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
        PACKAGE_ARCHITECTURE<span class="token operator">=</span><span class="token string">&quot;-x86_64&quot;</span>
        PACKAGE_FILENAME<span class="token operator">=</span><span class="token string">&quot;aws-discovery-agent<span class="token variable">${PACKAGE_ARCHITECTURE}</span>.<span class="token variable">${PACKAGE_TYPE}</span>&quot;</span>
    <span class="token keyword">else</span>
        PACKAGE_FILENAME<span class="token operator">=</span><span class="token string">&quot;aws-discovery-agent.<span class="token variable">${PACKAGE_TYPE}</span>&quot;</span>
    <span class="token keyword">fi</span><span class="token punctuation">;</span>

    <span class="token keyword">echo</span> <span class="token string">&quot;Using <span class="token variable">${PACKAGE_TYPE}</span> and <span class="token variable">${OS_PACKAGE_MGR}</span> for package management. Expected agent package name is <span class="token variable">${PACKAGE_FILENAME}</span>.&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> create_secure_tmp_dir<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SECURE_TMP_DIR<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>mktemp -d /tmp/awsdiscoveryagent.XXXXXXXX<span class="token variable">)</span></span>
    <span class="token comment"># Cleanup hooks</span>
    <span class="token function">trap</span> <span class="token string">&quot;rm -f <span class="token variable">${SECURE_TMP_DIR}</span>/*; rmdir <span class="token variable">${SECURE_TMP_DIR}</span>&quot;</span> SIGTERM SIGINT EXIT
    <span class="token comment"># Check that the dir exists and is owned by our euid (root)</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token operator">!</span> -O <span class="token variable">${SECURE_TMP_DIR}</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;Unable to create secure temporary directory <span class="token variable">${SECURE_TMP_DIR}</span>.&quot;</span>
        exit_run_once <span class="token variable">${PID_FILE}</span> 1
    <span class="token keyword">fi</span>
    <span class="token function">chmod</span> 700 <span class="token variable">${SECURE_TMP_DIR}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> get_key_fingerprint<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    local key_file<span class="token operator">=</span><span class="token variable">${1}</span>
    local key_fingerprint<span class="token operator">=</span><span class="token string">&quot;&quot;</span>
    gpg -q --no-default-keyring --keyring <span class="token variable">${key_file}</span> --with-colons --fingerprint <span class="token operator">|</span> <span class="token keyword">while</span> IFS<span class="token operator">=</span>: <span class="token function">read</span> -ra arr<span class="token punctuation">;</span> <span class="token keyword">do</span>
        local tag<span class="token operator">=</span><span class="token variable">${arr[0]}</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;fpr&quot;</span> <span class="token operator">==</span> <span class="token string">&quot;<span class="token variable">${tag}</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
            <span class="token comment"># Found the tagged line with the fingerprint. Output to stdout.</span>
            key_fingerprint<span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${arr[9]}</span>&quot;</span>
            <span class="token keyword">echo</span> <span class="token string">&quot;<span class="token variable">${key_fingerprint}</span>&quot;</span>
        <span class="token keyword">fi</span>
    <span class="token keyword">done</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> pin_or_verify_key<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    local key_file<span class="token operator">=</span><span class="token variable">${1}</span>
    local pinned_keys_path<span class="token operator">=</span><span class="token variable">${2}</span>

    <span class="token comment"># Get the fingerprint of the input GPG key</span>
    local key_fingerprint<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>get_key_fingerprint $<span class="token punctuation">{</span>key_file<span class="token punctuation">}</span><span class="token variable">)</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> -z <span class="token variable">${key_fingerprint}</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;No key fingerprint was found for <span class="token variable">${key_file}</span>&quot;</span>
        exit_run_once <span class="token variable">${PID_FILE}</span> 1
    <span class="token keyword">fi</span>

    <span class="token comment"># Create the pinned keys directory as needed</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d <span class="token variable">${pinned_keys_path}</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;Creating directory for GPG key pinning: <span class="token variable">${pinned_keys_path}</span>&quot;</span>
        <span class="token function">mkdir</span> -p <span class="token variable">${pinned_keys_path}</span>
    <span class="token keyword">fi</span>

    <span class="token comment"># See if we have any pinned keys</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> -A $<span class="token punctuation">{</span>pinned_keys_path<span class="token punctuation">}</span><span class="token variable">)</span></span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token comment"># We have pinned keys, see if one matches the downloaded key</span>
        <span class="token keyword">for</span> pinned <span class="token keyword">in</span> <span class="token string">&quot;<span class="token variable">${pinned_keys_path}</span>*&quot;</span>
        <span class="token keyword">do</span>
          local pinned_fingerprint<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>get_key_fingerprint $<span class="token punctuation">{</span>pinned<span class="token punctuation">}</span><span class="token variable">)</span></span>
          <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">${pinned_fingerprint}</span>&quot;</span> <span class="token operator">==</span> <span class="token string">&quot;<span class="token variable">${key_fingerprint}</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
            <span class="token keyword">echo</span> <span class="token string">&quot;Found matching pinned key for <span class="token variable">${key_fingerprint}</span>&quot;</span>
            <span class="token keyword">return</span> 0
          <span class="token keyword">fi</span>
        <span class="token keyword">done</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;None of the pinned keys in <span class="token variable">${pinned_keys_path}</span> match the fingerprint <span class="token variable">${key_fingerprint}</span>&quot;</span>
        exit_run_once <span class="token variable">${PID_FILE}</span> 1
    <span class="token keyword">else</span>
        <span class="token comment"># No pinned keys; pin the downloaded key</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;No pinned keys found in <span class="token variable">${pinned_keys_path}</span>; pinning key with fingerprint <span class="token variable">${key_fingerprint}</span>&quot;</span>
        <span class="token function">cp</span> <span class="token string">&quot;<span class="token variable">${key_file}</span>&quot;</span> <span class="token string">&quot;<span class="token variable">${pinned_keys_path}</span>&quot;</span>
    <span class="token keyword">fi</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> download_and_verify_sig<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    local download_url<span class="token operator">=</span><span class="token variable">$1</span>
    local download_file_name<span class="token operator">=</span><span class="token variable">$2</span>

    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> -z <span class="token string">&quot;<span class="token variable">${SECURE_TMP_DIR}</span>&quot;</span> <span class="token operator">||</span> <span class="token operator">!</span> -d <span class="token string">&quot;<span class="token variable">${SECURE_TMP_DIR}</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;Secure temporary directory <span class="token variable">${SECURE_TMP_DIR}</span> is undefined or does not exist.&quot;</span>
        exit_run_once <span class="token variable">${PID_FILE}</span> 1
    <span class="token keyword">fi</span>

    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> -z <span class="token string">&quot;<span class="token variable">${PUBKEY_PATH}</span>&quot;</span> <span class="token operator">||</span> <span class="token operator">!</span> -s <span class="token string">&quot;<span class="token variable">${PUBKEY_PATH}</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;Public key file <span class="token variable">${PUBKEY_FILE}</span> is undefined or does not exist.&quot;</span>
        exit_run_once <span class="token variable">${PID_FILE}</span> 1
    <span class="token keyword">fi</span>

    <span class="token comment"># get the file</span>
    <span class="token variable">${CURL}</span> -o <span class="token string">&quot;<span class="token variable">${SECURE_TMP_DIR}</span>/<span class="token variable">${download_file_name}</span>&quot;</span> <span class="token string">&quot;<span class="token variable">${download_url}</span>&quot;</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$?</span> -ne 0 <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;Failed to download the <span class="token variable">${download_file_name}</span> from <span class="token variable">${download_url}</span>&quot;</span>
        exit_run_once <span class="token variable">${PID_FILE}</span> 1
    <span class="token keyword">fi</span>

    <span class="token comment"># get the corresponding signature file</span>
    <span class="token variable">${CURL}</span> -o <span class="token string">&quot;<span class="token variable">${SECURE_TMP_DIR}</span>/<span class="token variable">${download_file_name}</span>.sig&quot;</span> <span class="token string">&quot;<span class="token variable">${download_url}</span>.sig&quot;</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$?</span> -ne 0 <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;Failed to download the <span class="token variable">${download_file_name}</span> signature from <span class="token variable">${download_url}</span>.sig&quot;</span>
        exit_run_once <span class="token variable">${PID_FILE}</span> 1
    <span class="token keyword">fi</span>

    gpg_results<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span> gpg -q --no-default-keyring --keyring <span class="token string">&quot;<span class="token variable">${PUBKEY_PATH}</span>&quot;</span> --verify <span class="token string">&quot;<span class="token variable">${SECURE_TMP_DIR}</span>/<span class="token variable">${download_file_name}</span>.sig&quot;</span> <span class="token string">&quot;<span class="token variable">${SECURE_TMP_DIR}</span>/<span class="token variable">${download_file_name}</span>&quot;</span> 2<span class="token operator">&gt;</span><span class="token operator">&amp;</span>1 <span class="token variable">)</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$?</span> -eq 0 <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;Validated <span class="token variable">${download_file_name}</span> signature with: <span class="token variable"><span class="token variable">$(</span><span class="token keyword">echo</span> <span class="token string">&quot;<span class="token variable">${gpg_results}</span>&quot;</span> <span class="token operator">|</span> <span class="token function">grep</span> -i fingerprint<span class="token variable">)</span></span>&quot;</span>
    <span class="token keyword">else</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;Error validating signature of <span class="token variable">${download_file_name}</span>, terminating.  Please contact AWS Support.&quot;</span>
        <span class="token keyword">echo</span> <span class="token variable">${gpg_results}</span>
        exit_run_once <span class="token variable">${PID_FILE}</span> 1
    <span class="token keyword">fi</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> get_existing_version<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    local agent_version_file<span class="token operator">=</span>/var/opt/aws/discovery/version
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> -f <span class="token variable">${agent_version_file}</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        EXISTING_VERSION<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token operator">&lt;</span>$<span class="token punctuation">{</span>agent_version_file<span class="token punctuation">}</span><span class="token variable">)</span></span>
    <span class="token keyword">else</span>
        EXISTING_VERSION<span class="token operator">=</span>0
    <span class="token keyword">fi</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> is_version_greater_than<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    local v1<span class="token operator">=</span><span class="token punctuation">(</span> <span class="token variable"><span class="token variable">$(</span><span class="token keyword">echo</span> <span class="token string">&quot;<span class="token variable">$1</span>&quot;</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token string">'.'</span> <span class="token string">' '</span><span class="token variable">)</span></span> <span class="token punctuation">)</span>
    local v2<span class="token operator">=</span><span class="token punctuation">(</span> <span class="token variable"><span class="token variable">$(</span><span class="token keyword">echo</span> <span class="token string">&quot;<span class="token variable">$2</span>&quot;</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token string">'.'</span> <span class="token string">' '</span><span class="token variable">)</span></span> <span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">${#v1[*]}</span> <span class="token operator">!=</span> 4 <span class="token operator">||</span> <span class="token variable">${#v1[*]}</span> <span class="token operator">!=</span> 4 <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
       <span class="token keyword">echo</span> <span class="token string">&quot;Warning - version numbers aren't expected lengths <span class="token variable">${1}</span>, <span class="token variable">${2}</span>&quot;</span>
    <span class="token keyword">fi</span>
    <span class="token keyword">for</span> <span class="token variable"><span class="token punctuation">((</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">))</span></span>
    <span class="token keyword">do</span>
       <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">${v1[i]:-0}</span>&quot;</span> -gt <span class="token string">&quot;<span class="token variable">${v2[i]:-0}</span>&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
          <span class="token boolean">true</span>
          <span class="token keyword">return</span>
       <span class="token keyword">fi</span>
       <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">${v1[i]:-0}</span>&quot;</span> -lt <span class="token string">&quot;<span class="token variable">${v2[i]:-0}</span>&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
          <span class="token keyword">break</span>
       <span class="token keyword">fi</span>
    <span class="token keyword">done</span>
    <span class="token boolean">false</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> get_base_url<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    BUCKET<span class="token operator">=</span><span class="token string">&quot;aws-discovery-agent.<span class="token variable">${REGION}</span>&quot;</span>
    BASE_URL<span class="token operator">=</span><span class="token string">&quot;https://s3-<span class="token variable">${REGION}</span>.amazonaws.com/<span class="token variable">${BUCKET}</span>&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> get_actual_package_hash<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ACTUAL_PACKAGE_HASH<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span> sha256sum $<span class="token punctuation">{</span>LOCAL_PACKAGE_FILE<span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token function">cut</span> -f1 -d<span class="token string">' '</span><span class="token variable">)</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> download_and_verify_package<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> -z <span class="token variable">${BASE_URL}</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        get_base_url
    <span class="token keyword">fi</span>

    <span class="token comment"># Create a Secure temp directory SECURE_TMP_DIR where we get all files and then use them.</span>
    create_secure_tmp_dir

    <span class="token comment"># get the public key</span>
    PUBKEY_PATH<span class="token operator">=</span><span class="token variable">${SECURE_TMP_DIR}</span>/<span class="token variable">${PUBKEY_FILE}</span>
    <span class="token variable">${CURL}</span> -o <span class="token variable">${PUBKEY_PATH}</span> <span class="token string">&quot;<span class="token variable">${BASE_URL}</span>/linux/latest/<span class="token variable">${PUBKEY_FILE}</span>&quot;</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token operator">!=</span> 0 <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;Failed to download public key from the path <span class="token variable">${BASE_URL}</span>/linux/latest/<span class="token variable">${PUBKEY_FILE}</span>&quot;</span>
        exit_run_once <span class="token variable">${PIDFILE}</span> 1
    <span class="token keyword">fi</span>

    <span class="token comment"># get the discovery agent current release file (which provides latest release version and URL of the release manifest)</span>
    CURRENT_RELEASE_URL<span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${BASE_URL}</span>/linux/latest/<span class="token variable">${CURRENT_RELEASE_FILE}</span>&quot;</span>
    download_and_verify_sig <span class="token string">&quot;<span class="token variable">${CURRENT_RELEASE_URL}</span>&quot;</span> <span class="token string">&quot;<span class="token variable">${CURRENT_RELEASE_FILE}</span>&quot;</span>

    <span class="token comment"># get the release manifest file</span>
    RELEASE_MANIFEST_URL<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">head</span> -1 $<span class="token punctuation">{</span>SECURE_TMP_DIR<span class="token punctuation">}</span>/$<span class="token punctuation">{</span>CURRENT_RELEASE_FILE<span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token function">cut</span> -f2 -d <span class="token string">' '</span><span class="token variable">)</span></span>
    download_and_verify_sig <span class="token string">&quot;<span class="token variable">${RELEASE_MANIFEST_URL}</span>&quot;</span> <span class="token string">&quot;<span class="token variable">${RELEASE_MANIFEST_FILE}</span>&quot;</span>

    <span class="token keyword">echo</span> <span class="token string">&quot;The expected package file name from agent manifest is <span class="token variable">${PACKAGE_FILENAME}</span>.&quot;</span>
    PACKAGE_FILE_URL<span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> $<span class="token punctuation">{</span>PACKAGE_FILENAME<span class="token punctuation">}</span> $<span class="token punctuation">{</span>SECURE_TMP_DIR<span class="token punctuation">}</span>/$<span class="token punctuation">{</span>RELEASE_MANIFEST_FILE<span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token function">grep</span> -v $<span class="token punctuation">{</span>PACKAGE_FILENAME<span class="token punctuation">}</span>.sig <span class="token operator">|</span> <span class="token function">cut</span> -f3 -d <span class="token string">' '</span><span class="token variable">)</span></span>&quot;</span>

    download_and_verify_sig <span class="token string">&quot;<span class="token variable">${PACKAGE_FILE_URL}</span>&quot;</span> <span class="token string">&quot;<span class="token variable">${PACKAGE_FILENAME}</span>&quot;</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token operator">!</span> -s <span class="token variable">${SECURE_TMP_DIR}</span>/<span class="token variable">${PACKAGE_FILENAME}</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;Failed to download package from the path <span class="token variable">${PACKAGE_FILE_URL}</span>.&quot;</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;Please contact AWS support to report this issue.&quot;</span>
    <span class="token keyword">fi</span>

    <span class="token comment"># Check the hash of the package downloaded vs. the hash of the package in the manifest</span>
    LOCAL_PACKAGE_FILE<span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${SECURE_TMP_DIR}</span>/<span class="token variable">${PACKAGE_FILENAME}</span>&quot;</span>
    get_actual_package_hash
    EXPECTED_PACKAGE_HASH<span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> $<span class="token punctuation">{</span>PACKAGE_FILENAME<span class="token punctuation">}</span> $<span class="token punctuation">{</span>SECURE_TMP_DIR<span class="token punctuation">}</span>/$<span class="token punctuation">{</span>RELEASE_MANIFEST_FILE<span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token function">grep</span> -v $<span class="token punctuation">{</span>PACKAGE_FILENAME<span class="token punctuation">}</span>.sig <span class="token operator">|</span> <span class="token function">cut</span> -f2 -d <span class="token string">' '</span><span class="token variable">)</span></span>&quot;</span>

    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">${ACTUAL_PACKAGE_HASH}</span>&quot;</span> <span class="token operator">!=</span> <span class="token string">&quot;<span class="token variable">${EXPECTED_PACKAGE_HASH}</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;Package sha256 hash does not match expected package hash from package index.&quot;</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;Please contact AWS support to report this issue.&quot;</span>
        exit_run_once <span class="token variable">${PIDFILE}</span> 1
    <span class="token keyword">else</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;Validated package sha256 hash matches expected value.&quot;</span>
    <span class="token keyword">fi</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> setup_curl_prefix<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    local curl_args<span class="token operator">=</span><span class="token string">&quot;-s --fail --retry 5 --max-time 30&quot;</span>

    <span class="token comment"># Optionally add CA bundle path.</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">${USE_DISCOVERY_CA_BUNDLE}</span>&quot;</span> <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        curl_args<span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${curl_args}</span> --cacert <span class="token variable">${DISCOVERY_CA_BUNDLE_FILE}</span>&quot;</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;Using CA certificate bundle at <span class="token variable">${DISCOVERY_CA_BUNDLE_FILE}</span>&quot;</span>
    <span class="token keyword">elif</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">${USE_DISCOVERY_CURL}</span>&quot;</span> <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token comment"># Linux distributions have a variety of locations for public root certificates. Since we compile cURL on RHEL,</span>
        <span class="token comment"># it defaults to that location, therefore we need to dynamically set the desired CA path based on what path</span>
        <span class="token comment"># exists.</span>
        local -a possible_ca_paths<span class="token operator">=</span><span class="token punctuation">(</span>
            <span class="token string">&quot;/etc/ssl/certs/ca-certificates.crt&quot;</span>
            <span class="token string">&quot;/etc/pki/tls/certs/ca-bundle.crt&quot;</span>
            <span class="token string">&quot;/etc/ssl/ca-bundle.pem&quot;</span>
            <span class="token string">&quot;/etc/pki/tls/cacert.pem&quot;</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">for</span> path <span class="token keyword">in</span> <span class="token variable">${possible_ca_paths[@]}</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
            <span class="token keyword">if</span> <span class="token punctuation">[</span> -f <span class="token variable">${path}</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
                curl_args<span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${curl_args}</span> --cacert <span class="token variable">${path}</span>&quot;</span>
                <span class="token keyword">echo</span> <span class="token string">&quot;Using CA certificate bundle at <span class="token variable">${path}</span>&quot;</span>
            <span class="token keyword">fi</span>
        <span class="token keyword">done</span>
    <span class="token keyword">fi</span>

    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">${USE_DISCOVERY_CURL}</span>&quot;</span> <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token comment"># Replace the global curl prefix with one using the curl installed along with the agent</span>
        <span class="token function">export</span> LD_LIBRARY_PATH<span class="token operator">=</span><span class="token variable">${DISCOVERY_BIN_DIR}</span>
        CURL<span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${DISCOVERY_BIN_DIR}</span>curl <span class="token variable">${curl_args}</span> &quot;</span>
    <span class="token keyword">else</span>
        <span class="token comment"># Just use the cURL that is part of the Linux distribution.</span>
        CURL<span class="token operator">=</span><span class="token string">&quot;curl <span class="token variable">${curl_args}</span> &quot;</span>
    <span class="token keyword">fi</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> in_array<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment"># Find a Needle inside Haystack</span>
    local haystack<span class="token operator">=</span><span class="token variable">${1}</span><span class="token punctuation">[</span>@<span class="token punctuation">]</span>
    local needle<span class="token operator">=</span><span class="token variable">${2}</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token variable">${!haystack}</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">${i}</span> <span class="token operator">==</span> <span class="token variable">${needle}</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
            <span class="token keyword">return</span> 0
        <span class="token keyword">fi</span>
    <span class="token keyword">done</span>
    <span class="token keyword">return</span> 1
<span class="token punctuation">}</span>

<span class="token keyword">function</span> lowercase<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">echo</span> <span class="token string">&quot;<span class="token variable">$1</span>&quot;</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">&quot;y/ABCDEFGHIJKLMNOPQRSTUVWXYZ/abcdefghijklmnopqrstuvwxyz/&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> get_os_info <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    OS<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>lowercase \<span class="token variable">`</span></span>uname\`<span class="token variable"><span class="token variable">`</span>
    MACH<span class="token operator">=</span><span class="token variable">`</span></span><span class="token function">uname</span> -m<span class="token variable"><span class="token variable">`</span>

    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">${OS}</span>&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;linux&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
      # Figure out <span class="token function">which</span> OS we are running on
      <span class="token keyword">if</span> <span class="token punctuation">[</span> -f /etc/os-release <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
          <span class="token function">source</span> /etc/os-release
          DIST_TYPE<span class="token operator">=</span>$ID
          DIST<span class="token operator">=</span>$NAME
          REV<span class="token operator">=</span>$VERSION_ID
      <span class="token keyword">elif</span> <span class="token punctuation">[</span> -f /usr/lib/os-release <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
          <span class="token function">source</span> /usr/lib/os-release
          DIST_TYPE<span class="token operator">=</span>$ID
          DIST<span class="token operator">=</span>$NAME
          REV<span class="token operator">=</span>$VERSION_ID
      <span class="token keyword">elif</span> <span class="token punctuation">[</span> -f /etc/centos-release <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
          DIST_TYPE<span class="token operator">=</span><span class="token string">'CentOS'</span>
          DIST<span class="token operator">=</span><span class="token variable">`</span></span><span class="token function">cat</span> /etc/centos-release <span class="token operator">|</span><span class="token function">sed</span> s/\ release.*//<span class="token variable"><span class="token variable">`</span>
          REV<span class="token operator">=</span><span class="token variable">`</span></span><span class="token function">cat</span> /etc/centos-release <span class="token operator">|</span> <span class="token function">sed</span> s/.*release\ // <span class="token operator">|</span> <span class="token function">sed</span> s/\ .*//<span class="token variable"><span class="token variable">`</span>
      <span class="token keyword">elif</span> <span class="token punctuation">[</span> -f /etc/redhat-release <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
          DIST_TYPE<span class="token operator">=</span><span class="token string">'RedHat'</span>
          DIST<span class="token operator">=</span><span class="token variable">`</span></span><span class="token function">cat</span> /etc/redhat-release <span class="token operator">|</span><span class="token function">sed</span> s/\ release.*//<span class="token variable"><span class="token variable">`</span>
          REV<span class="token operator">=</span><span class="token variable">`</span></span><span class="token function">cat</span> /etc/redhat-release <span class="token operator">|</span> <span class="token function">sed</span> s/.*release\ // <span class="token operator">|</span> <span class="token function">sed</span> s/\ .*//<span class="token variable"><span class="token variable">`</span>
      <span class="token keyword">elif</span> <span class="token punctuation">[</span> -f /etc/system-release <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
          <span class="token keyword">if</span> <span class="token function">grep</span> <span class="token string">&quot;Amazon Linux AMI&quot;</span> /etc/system-release<span class="token punctuation">;</span> <span class="token keyword">then</span>
            DIST_TYPE<span class="token operator">=</span><span class="token string">'amzn'</span>
          <span class="token keyword">fi</span>
          DIST<span class="token operator">=</span><span class="token variable">`</span></span><span class="token function">cat</span> /etc/system-release <span class="token operator">|</span><span class="token function">sed</span> s/\ release.*//<span class="token variable"><span class="token variable">`</span>
          REV<span class="token operator">=</span><span class="token variable">`</span></span><span class="token function">cat</span> /etc/system-release <span class="token operator">|</span> <span class="token function">sed</span> s/.*release\ // <span class="token operator">|</span> <span class="token function">sed</span> s/\ .*//<span class="token variable"><span class="token variable">`</span>
      <span class="token keyword">elif</span> <span class="token punctuation">[</span> -f /etc/SuSE-release <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
          DIST_TYPE<span class="token operator">=</span><span class="token string">'SuSe'</span>
          DIST<span class="token operator">=</span><span class="token variable">`</span></span><span class="token function">head</span> -n1 /etc/SuSE-release <span class="token operator">|</span> <span class="token function">cut</span> -d<span class="token string">&quot; &quot;</span> -f1<span class="token variable"><span class="token variable">`</span>
          REV<span class="token operator">=</span><span class="token variable">`</span></span><span class="token function">cat</span> /etc/SuSE-release <span class="token operator">|</span> <span class="token function">tr</span> <span class="token string">&quot;\n&quot;</span> <span class="token string">' '</span> <span class="token operator">|</span> <span class="token function">sed</span> s/.*<span class="token operator">=</span>\ //<span class="token variable"><span class="token variable">`</span>
      <span class="token keyword">elif</span> <span class="token punctuation">[</span> -f /etc/mandrake-release <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
          DIST_TYPE<span class="token operator">=</span><span class="token string">'Mandrake'</span>
          REV<span class="token operator">=</span><span class="token variable">`</span></span><span class="token function">cat</span> /etc/mandrake-release <span class="token operator">|</span> <span class="token function">sed</span> s/.*release\ // <span class="token operator">|</span> <span class="token function">sed</span> s/\ .*//<span class="token variable"><span class="token variable">`</span>
      <span class="token keyword">elif</span> <span class="token punctuation">[</span> -f /etc/debian_version <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
          DIST_TYPE<span class="token operator">=</span><span class="token string">'Debian'</span>
          DIST<span class="token operator">=</span><span class="token variable">`</span></span><span class="token function">cat</span> /etc/lsb-release <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'^DISTRIB_ID'</span> <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token operator">=</span>  <span class="token string">'{ print <span class="token variable">$2</span> }'</span><span class="token variable"><span class="token variable">`</span>
          REV<span class="token operator">=</span><span class="token variable">`</span></span><span class="token function">cat</span> /etc/lsb-release <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'^DISTRIB_RELEASE'</span> <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token operator">=</span>  <span class="token string">'{ print <span class="token variable">$2</span> }'</span><span class="token variable"><span class="token variable">`</span>
      <span class="token keyword">fi</span>
      <span class="token keyword">if</span> <span class="token punctuation">[</span> -f /etc/UnitedLinux-release <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
          DIST<span class="token operator">=</span>&quot;$<span class="token punctuation">{</span>DIST<span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token variable">`</span></span><span class="token function">cat</span> /etc/UnitedLinux-release <span class="token operator">|</span> <span class="token function">tr</span> <span class="token string">&quot;\n&quot;</span> ' ' <span class="token operator">|</span> <span class="token function">sed</span> s/VERSION.*//<span class="token variable"><span class="token variable">`</span><span class="token punctuation">]</span><span class="token string">&quot;
      fi
    fi

    if [ &quot;</span>$<span class="token punctuation">{</span>OS<span class="token punctuation">}</span><span class="token string">&quot; == &quot;</span>darwin&quot; <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        OS<span class="token operator">=</span>mac
    <span class="token keyword">fi</span>

    DIST_TYPE<span class="token operator">=</span><span class="token variable">`</span></span>lowercase <span class="token variable">$DIST_TYPE</span>`

    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> -z <span class="token string">&quot;<span class="token variable">${DIST}</span>&quot;</span> <span class="token operator">||</span> -z <span class="token string">&quot;<span class="token variable">${DIST_TYPE}</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;Unsupported distribution: <span class="token variable">${DIST}</span> and distribution type: <span class="token variable">${DIST_TYPE}</span>&quot;</span>
        <span class="token keyword">exit</span> 1
    <span class="token keyword">fi</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> ensure_32bit_c_runtime<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    local install_method<span class="token operator">=</span><span class="token variable">$1</span>

    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">${MACH}</span>&quot;</span> <span class="token operator">==</span> <span class="token string">&quot;x86_64&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token comment"># If we're on 64bit linux, use specified method to install 32bit C runtime</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">${install_method}</span> <span class="token operator">==</span> <span class="token string">&quot;apt-get&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
            <span class="token keyword">if</span> <span class="token operator">!</span> dpkg -s libc6:i386<span class="token operator">&gt;</span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span>
                dpkg --add-architecture i386
                <span class="token function">apt-get</span> update
                <span class="token function">apt-get</span> <span class="token function">install</span> -y libc6:i386
                <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$?</span> -ne 0 <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
                    <span class="token keyword">echo</span> <span class="token string">&quot;Failed to install libc:i386&quot;</span>
                    exit_run_once <span class="token variable">${PID_FILE}</span> 1
                <span class="token keyword">fi</span>
            <span class="token keyword">fi</span>
        <span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token variable">${install_method}</span> <span class="token operator">==</span> <span class="token string">&quot;yum&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
            <span class="token keyword">if</span> <span class="token operator">!</span> yum list installed glibc.i686<span class="token operator">&gt;</span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span>
                yum -y <span class="token function">install</span> glibc.i686
                <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$?</span> -ne 0 <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
                    <span class="token keyword">echo</span> <span class="token string">&quot;Failed to install glibc.i686&quot;</span>
                    exit_run_once <span class="token variable">${PID_FILE}</span> 1
                <span class="token keyword">fi</span>
            <span class="token keyword">fi</span>
        <span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token variable">${install_method}</span> <span class="token operator">==</span> <span class="token string">&quot;zypper&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
            <span class="token keyword">if</span> <span class="token operator">!</span> zypper se -i glibc-32bit<span class="token operator">&gt;</span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span>
                zypper refresh
                zypper --non-interactive <span class="token function">install</span> glibc-32bit
                <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$?</span> -ne 0 <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
                    <span class="token keyword">echo</span> <span class="token string">&quot;Failed to install glibc-32bit&quot;</span>
                    exit_run_once <span class="token variable">${PID_FILE}</span> 1
                <span class="token keyword">fi</span>
            <span class="token keyword">fi</span>
            <span class="token keyword">if</span> <span class="token operator">!</span> zypper se -i glibc-locale-32bit<span class="token operator">&gt;</span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span>
                zypper refresh
                zypper --non-interactive <span class="token function">install</span> glibc-locale-32bit
                <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$?</span> -ne 0 <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
                    <span class="token keyword">echo</span> <span class="token string">&quot;Failed to install glibc-locale-32bit&quot;</span>
                    exit_run_once <span class="token variable">${PID_FILE}</span> 1
                <span class="token keyword">fi</span>
            <span class="token keyword">fi</span>
        <span class="token keyword">fi</span>
    <span class="token keyword">fi</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> daemon_action<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    local action<span class="token operator">=</span><span class="token variable">$1</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">${action}</span> <span class="token operator">!=</span> <span class="token string">&quot;stop&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">${action}</span> <span class="token operator">!=</span> <span class="token string">&quot;start&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">${action}</span> <span class="token operator">!=</span> <span class="token string">&quot;restart&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;Unsupported daemon action: <span class="token variable">${action}</span>&quot;</span>
        <span class="token keyword">exit</span> 1
    <span class="token keyword">fi</span>

    <span class="token comment"># Use heuristics to determine correct method to carry out the requested action on aws-discovery-daemon.</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -z <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>/sbin/init --version 2<span class="token operator">&gt;</span>/dev/null <span class="token operator">|</span> <span class="token function">grep</span> -e <span class="token string">'upstart'</span><span class="token variable">)</span></span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        initctl <span class="token variable">${action}</span> aws-discovery-daemon
        <span class="token function">wait</span>  <span class="token comment"># Wait until daemon has completed action.</span>
    <span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -z <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>systemctl 2<span class="token operator">&gt;</span>/dev/null <span class="token operator">|</span> <span class="token function">grep</span> -F -e -.mount<span class="token variable">)</span></span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span> -f <span class="token variable">${systemd_file}</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
            systemctl <span class="token variable">${action}</span> aws-discovery-daemon
            <span class="token function">wait</span>  <span class="token comment"># Wait until daemon has completed action.</span>
        <span class="token keyword">else</span>
            <span class="token keyword">echo</span> <span class="token string">'ERR: expected aws-discovery-daemon service description file but did not find it'</span><span class="token punctuation">;</span>
            <span class="token keyword">exit</span> 1
        <span class="token keyword">fi</span>
    <span class="token keyword">elif</span> <span class="token punctuation">[</span> -f /etc/init.d/aws-discovery-daemon <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        /etc/init.d/aws-discovery-daemon <span class="token variable">${action}</span>
        <span class="token function">wait</span>  <span class="token comment"># Wait until daemon has completed action.</span>
    <span class="token keyword">else</span>
        <span class="token keyword">echo</span> <span class="token string">'ERR: cannot determine method to stop aws-discovery-daemon'</span><span class="token punctuation">;</span>
        <span class="token keyword">exit</span> 1
    <span class="token keyword">fi</span>
<span class="token punctuation">}</span>


<span class="token keyword">function</span> print_header<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">echo</span> -e <span class="token string">&quot;\n&quot;</span>
    <span class="token keyword">echo</span> <span class="token string">&quot;**************************************************&quot;</span>
    <span class="token keyword">echo</span> <span class="token string">&quot;    <span class="token variable">$1</span>&quot;</span>
    <span class="token keyword">echo</span> <span class="token string">&quot;**************************************************&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">whoami</span><span class="token variable">)</span></span> <span class="token operator">!=</span> <span class="token string">&quot;root&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token keyword">echo</span> <span class="token string">&quot;Script is run as <span class="token variable"><span class="token variable">$(</span><span class="token function">whoami</span><span class="token variable">)</span></span>. Please run as root&quot;</span>
    <span class="token keyword">exit</span> 1
<span class="token keyword">fi</span>

PID_FILE<span class="token operator">=</span><span class="token string">&quot;/var/run/&quot;</span><span class="token variable"><span class="token variable">$(</span><span class="token function">basename</span> <span class="token punctuation">$(</span>readlink -f $0<span class="token variable">)</span></span><span class="token punctuation">)</span>.PID
init_run_once <span class="token variable">${PID_FILE}</span>

<span class="token keyword">declare</span> -a SUPPORTED_REGIONS<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;us-west-2&quot;</span><span class="token punctuation">)</span>
REGION<span class="token operator">=</span><span class="token string">&quot;us-west-2&quot;</span>
CURRENT_RELEASE_VERSION<span class="token operator">=</span><span class="token string">&quot;2.0.1129.0&quot;</span>
CURRENT_RELEASE_FILE<span class="token operator">=</span><span class="token string">&quot;CURRENT_RELEASE&quot;</span>
RELEASE_MANIFEST_FILE<span class="token operator">=</span><span class="token string">&quot;AWS_AGENT_INVENTORY&quot;</span>
PUBKEY_FILE<span class="token operator">=</span>discovery.gpg
UPDATE_AGENT<span class="token operator">=</span>true <span class="token comment"># Agent update choice to customer</span>
BASE_URL<span class="token operator">=</span><span class="token string">&quot;&quot;</span>
INSTALL_PREREQUISITES<span class="token operator">=</span>true
USE_DISCOVERY_CURL<span class="token operator">=</span>false
USE_DISCOVERY_CA_BUNDLE<span class="token operator">=</span>false
OP<span class="token operator">=</span>install <span class="token comment"># Default operation mode.</span>
PREVIOUS_PACKAGE_HASH<span class="token operator">=</span><span class="token string">&quot;&quot;</span>
AWS_KEY_ID<span class="token operator">=</span><span class="token string">&quot;&quot;</span>
AWS_KEY_SECRET<span class="token operator">=</span><span class="token string">&quot;&quot;</span>
LOCAL_PACKAGE_FILE<span class="token operator">=</span><span class="token string">&quot;&quot;</span>
LOCAL_PACKAGE_DIR<span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span> <span class="token function">cd</span> <span class="token string">&quot;$( dirname &quot;</span>$<span class="token punctuation">{</span>BASH_SOURCE<span class="token punctuation">[</span>0<span class="token punctuation">]</span><span class="token punctuation">}</span>&quot; <span class="token variable">)</span></span>&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token function">pwd</span> <span class="token punctuation">)</span><span class="token string">&quot;

# Destination location constants.
INSTALL_CONFIG_FILE=/var/opt/aws/discovery/install.cfg
AGENT_CONFIG_FILE=/var/opt/aws/discovery/config

# Potential previous inspector agents that might be installed
PREVIEW_INSPECTOR_AGENT=/opt/aws/inspector/bin/inspector
V1_DISCOVERY_AGENT=/opt/aws/awsagent/bin/awsagent

# Load prior settings if the config file exists
if [[ -s &quot;</span><span class="token variable">${INSTALL_CONFIG_FILE}</span><span class="token string">&quot; ]]; then
    echo &quot;</span>Loading saved installer configuration from <span class="token variable">${INSTALL_CONFIG_FILE}</span><span class="token keyword">.</span><span class="token string">&quot;
    source <span class="token variable">${INSTALL_CONFIG_FILE}</span>
fi

# Parse command line options for any customer specified overrides
function print_usage() {
    echo &quot;</span>Usage:<span class="token string">&quot;
    echo &quot;</span>    <span class="token function">sudo</span> <span class="token function">bash</span> <span class="token function">install</span> -k <span class="token punctuation">[</span>AWS key ID<span class="token punctuation">]</span> -s <span class="token punctuation">[</span>AWS key secret<span class="token punctuation">]</span><span class="token string">&quot;
    echo
    echo &quot;</span>To turn off auto-update:<span class="token string">&quot;
    echo &quot;</span>    <span class="token function">sudo</span> <span class="token function">bash</span> <span class="token function">install</span> -k <span class="token punctuation">[</span>AWS key ID<span class="token punctuation">]</span> -s <span class="token punctuation">[</span>AWS key secret<span class="token punctuation">]</span> -u <span class="token boolean">false</span><span class="token string">&quot;
    echo
    echo &quot;</span>To run locally on Linux distributions that don<span class="token string">'t have working package repositories and/or up-to-date curl binaries:&quot;
    echo &quot;    sudo bash install -k [AWS key ID] -s [AWS key secret] -p false -c true -b true&quot;
}

while getopts &quot;r:u:k:s:l:p:c:b:a:h&quot; opt; do
    case <span class="token variable">${opt}</span> in
        c)
            echo &quot;Use cURL installed with the agent option specified as: <span class="token variable">${OPTARG}</span>.&quot;
            validate_boolean <span class="token variable">${OPTARG}</span>
            USE_DISCOVERY_CURL=<span class="token variable">${OPTARG}</span>
            ;;
        b)
            echo &quot;Use the certificate authority (CA) bundle installed with the agent specified as: <span class="token variable">${OPTARG}</span>.&quot;
            validate_boolean <span class="token variable">${OPTARG}</span>
            USE_DISCOVERY_CA_BUNDLE=<span class="token variable">${OPTARG}</span>
            ;;
        r)
            echo &quot;Custom AWS region option specified as: <span class="token variable">${OPTARG}</span>.&quot;
            REGION=<span class="token variable">${OPTARG}</span>
            ;;
        u)
            echo &quot;Auto update option specified as: <span class="token variable">${OPTARG}</span>.&quot;
            validate_boolean <span class="token variable">${OPTARG}</span>
            UPDATE_AGENT=<span class="token variable">${OPTARG}</span>
            ;;
        p)
            echo &quot;Install prerequisites option specified as: <span class="token variable">${OPTARG}</span>.&quot;
            INSTALL_PREREQUISITES=<span class="token variable">${OPTARG}</span>
            ;;
        k)
            echo &quot;AWS key ID option specified as: <span class="token variable">${OPTARG}</span>.&quot;
            AWS_KEY_ID=<span class="token variable">${OPTARG}</span>
            ;;
        s)
            echo &quot;AWS key secret option specified.&quot;
            AWS_KEY_SECRET=<span class="token variable">${OPTARG}</span>
            ;;
        a)
            echo &quot;Installing '</span><span class="token variable">${OPTARG}</span><span class="token string">' bit.&quot;
            INSTALL_AGENT_ARCHITECTURE=&quot;<span class="token variable">${OPTARG}</span>&quot;
            ;;
        h)
            print_usage
            exit_run_once <span class="token variable">${PID_FILE}</span> 0
            ;;
        \?)
            echo &quot;Invalid option: -<span class="token variable">${OPTARG}</span>.&quot;
            print_usage
            exit_run_once <span class="token variable">${PID_FILE}</span> 1
            ;;
        :)
            echo &quot;Option -<span class="token variable">${OPTARG}</span> requires an argument.&quot;
            print_usage
            exit_run_once <span class="token variable">${PID_FILE}</span> 1
            ;;
    esac
done

print_header &quot;INIT PHASE&quot;

# Resolve DIST_TYPE, DIST, REV
get_os_info

echo &quot;Distribution type of the machine is <span class="token variable">${DIST_TYPE}</span>.&quot;
echo &quot;Distribution of the machine is <span class="token variable">${DIST}</span>.&quot; 
echo &quot;Revision of the distribution is <span class="token variable">${REV}</span>.&quot;

# check if the preview inspector agent runs
if [[ -f &quot;<span class="token variable">${PREVIEW_INSPECTOR_AGENT}</span>&quot; ]]; then
    echo &quot;Preview version of AWS Inspector Agent is still installed on this machine. Please refer to AWS documentation at https://aws.amazon.com/inspector to remove this agent before proceeding. &quot;
    exit_run_once <span class="token variable">${PID_FILE}</span> 1
fi

# check if the v1 inspector agent runs
if [[ -f &quot;<span class="token variable">${V1_DISCOVERY_AGENT}</span>&quot; ]]; then
    echo &quot;AWS Inspector Agent is still installed on this machine. Please refer to AWS documentation at https://aws.amazon.com/inspector to remove this agent before proceeding. &quot;
    exit_run_once <span class="token variable">${PID_FILE}</span> 1
fi

# Verify that we have a valid region
if [[ -n &quot;<span class="token variable">${REGION}</span>&quot; ]]; then
    if in_array SUPPORTED_REGIONS &quot;<span class="token variable">${REGION}</span>&quot;; then
        :
    else
        echo &quot;Invalid region of <span class="token variable">${REGION}</span>; AWS Discovery Agent is only supported in <span class="token variable">${SUPPORTED_REGIONS[@]}</span>.&quot;
        exit_run_once <span class="token variable">${PID_FILE}</span> 1
    fi
else
    echo &quot;No region information available.&quot;
    echo &quot;Usage: sudo bash install.sh -r #Region -u #Update&quot;
    echo &quot;AWS Discovery agent is only supported in <span class="token variable">${SUPPORTED_REGIONS[@]}</span>&quot;
    exit_run_once <span class="token variable">${PID_FILE}</span> 1
fi
echo &quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">hostname</span> -f<span class="token variable">)</span></span> is using IAM authentication with AWS region <span class="token variable">${REGION}</span>.&quot;

# Get the existing agent version
get_existing_version
if [[ <span class="token variable">${EXISTING_VERSION}</span> == 0 ]]; then
  echo &quot;There is no existing version of the AWS Discovery Agent on the machine.&quot;
else
  echo &quot;Existing version of the AWS Discovery Agent installed is <span class="token variable">${EXISTING_VERSION}</span>.&quot;
fi

# Verify that we have the required .deb/.rpm for the agent and that it is valid.
determine_os_package_manager
LOCAL_PACKAGE_FILE=&quot;<span class="token variable">${LOCAL_PACKAGE_DIR}</span>/<span class="token variable">${PACKAGE_FILENAME}</span>&quot;
echo &quot;Installing using local file <span class="token variable">${LOCAL_PACKAGE_FILE}</span>&quot;
if [[ ! -s <span class="token variable">${LOCAL_PACKAGE_FILE}</span> ]]; then
    print_header &quot;DOWNLOAD PHASE&quot;
    setup_curl_prefix
    download_and_verify_package
    # the following to be uncommented (with above four lines deleted) once we'</span>ve upgraded all pre-tar agents
    <span class="token comment">#echo &quot;Specified local installer file ${LOCAL_PACKAGE_FILE} does not exist.&quot;</span>
    <span class="token comment">#exit_run_once ${PID_FILE} 1</span>
<span class="token keyword">fi</span>
get_actual_package_hash

<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">${PREVIOUS_PACKAGE_HASH}</span>&quot;</span> <span class="token operator">!=</span> <span class="token string">&quot;<span class="token variable">${ACTUAL_PACKAGE_HASH}</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    print_header <span class="token string">&quot;INSTALL PREREQUISITES PHASE&quot;</span>

    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">${INSTALL_PREREQUISITES}</span>&quot;</span> <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;Verifying that the 32-bit C runtime is present.&quot;</span>
        ensure_32bit_c_runtime <span class="token variable">${OS_PACKAGE_MGR}</span>
    <span class="token keyword">else</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;Not installing prerequisites since this option was disabled.&quot;</span>
    <span class="token keyword">fi</span>

    print_header <span class="token string">&quot;INSTALL AGENT PHASE&quot;</span>

    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">${PACKAGE_FILENAME}</span> <span class="token operator">=</span>~ \.deb$ <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hash</span> dpkg 2<span class="token operator">&gt;</span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span>
      <span class="token keyword">echo</span> <span class="token string">&quot;Installing agent with dpkg...&quot;</span>
      dpkg -E -i <span class="token variable">${LOCAL_PACKAGE_FILE}</span>
    <span class="token keyword">elif</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">${PACKAGE_FILENAME}</span> <span class="token operator">=</span>~ \.rpm$ <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hash</span> rpm 2<span class="token operator">&gt;</span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span>
      <span class="token keyword">echo</span> <span class="token string">&quot;Installing agent with rpm...&quot;</span>
      rpm -ifU <span class="token variable">${LOCAL_PACKAGE_FILE}</span>
    <span class="token keyword">else</span>
      <span class="token keyword">echo</span> <span class="token string">&quot;No supported package managers are installed.&quot;</span>
      exit_run_once <span class="token variable">${PID_FILE}</span> 1
    <span class="token keyword">fi</span>

    <span class="token comment"># Update config (and restart daemon), if specified</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> -n <span class="token string">&quot;<span class="token variable">${REGION}</span>&quot;</span> <span class="token operator">&amp;&amp;</span> -n <span class="token string">&quot;<span class="token variable">${AWS_KEY_ID}</span>&quot;</span> <span class="token operator">&amp;&amp;</span> -n <span class="token string">&quot;<span class="token variable">${AWS_KEY_SECRET}</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;Updating config and restarting agent&quot;</span>

        <span class="token function">cat</span> <span class="token operator">&gt;</span> <span class="token variable">${AGENT_CONFIG_FILE}</span> <span class="token operator">&lt;&lt;</span>- EOM
<span class="token punctuation">{</span>
    <span class="token string">&quot;awsKeyId&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;<span class="token variable">${AWS_KEY_ID}</span>&quot;</span>,
    <span class="token string">&quot;awsKeySecret&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;<span class="token variable">${AWS_KEY_SECRET}</span>&quot;</span>,
    <span class="token string">&quot;awsRegion&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;<span class="token variable">${REGION}</span>&quot;</span>,
    <span class="token string">&quot;useAWSCABundle&quot;</span><span class="token keyword">:</span> <span class="token variable">${USE_DISCOVERY_CA_BUNDLE}</span>
<span class="token punctuation">}</span>
EOM

        daemon_action restart

    <span class="token keyword">else</span>
        <span class="token keyword">echo</span> <span class="token string">&quot;*** WARNING: You must provide AWS region, AWS key id, and AWS key secret to configure the AWS Discovery Agent.&quot;</span>
        print_usage
    <span class="token keyword">fi</span>

    print_header <span class="token string">&quot;FINISH PHASE&quot;</span>

    get_existing_version
    <span class="token keyword">echo</span>
    <span class="token keyword">echo</span> <span class="token string">&quot;Notice:&quot;</span>
    <span class="token keyword">echo</span> <span class="token string">&quot;By installing the Amazon Discovery Agent, you agree that your use is subject to the terms of your existing &quot;</span>
    <span class="token keyword">echo</span> <span class="token string">&quot;AWS Customer Agreement or other agreement with Amazon Web Services, Inc. or its affiliates governing your &quot;</span>
    <span class="token keyword">echo</span> <span class="token string">&quot;use of AWS services. You may not install and use the Amazon Discovery Agent unless you have an account in &quot;</span>
    <span class="token keyword">echo</span> <span class="token string">&quot;good standing with AWS.&quot;</span>
    <span class="token keyword">echo</span> <span class="token string">&quot;*  *  *&quot;</span>
    <span class="token keyword">echo</span> <span class="token string">&quot;Current running agent reports version as: <span class="token variable">${EXISTING_VERSION}</span>&quot;</span>
    <span class="token keyword">echo</span> <span class="token string">&quot;This install script was created to install agent version: 2.0.1129.0&quot;</span>
    <span class="token keyword">echo</span> <span class="token string">&quot;In most cases, these version numbers should be the same.&quot;</span>

    <span class="token comment"># Save the config so we can update with the same parameters</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> -s <span class="token string">&quot;<span class="token variable">${INSTALL_CONFIG_FILE}</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token function">rm</span> -f <span class="token variable">${INSTALL_CONFIG_FILE}</span>
    <span class="token keyword">fi</span>
    <span class="token function">cat</span> <span class="token operator">&gt;</span> <span class="token variable">${INSTALL_CONFIG_FILE}</span> <span class="token operator">&lt;&lt;</span>- EOM
REGION<span class="token operator">=</span><span class="token variable">${REGION}</span>
PREVIOUS_PACKAGE_HASH<span class="token operator">=</span><span class="token variable">${ACTUAL_PACKAGE_HASH}</span>
UPDATE_AGENT<span class="token operator">=</span><span class="token variable">${UPDATE_AGENT}</span>
BASE_URL<span class="token operator">=</span><span class="token variable">${BASE_URL}</span>
USE_DISCOVERY_CURL<span class="token operator">=</span><span class="token variable">${USE_DISCOVERY_CURL}</span>
USE_DISCOVERY_CA_BUNDLE<span class="token operator">=</span><span class="token variable">${USE_DISCOVERY_CA_BUNDLE}</span>
EOM

<span class="token keyword">else</span>
    print_header <span class="token string">&quot;FINISH PHASE&quot;</span>

    <span class="token keyword">echo</span> <span class="token string">&quot;Previously installed discovery agent and the newly pulled package have the same hash, so there is no need to update the package.&quot;</span>
    get_existing_version
    <span class="token keyword">echo</span> <span class="token string">&quot;Current running agent reports version as: <span class="token variable">${EXISTING_VERSION}</span>&quot;</span>
<span class="token keyword">fi</span>

exit_run_once <span class="token variable">${PID_FILE}</span> 0

</code></pre></div></div> <!----> <!----> </div></div><div class="global-ui"></div></div>
    <script src="/assets/js/2.c7d13bc3.js" defer></script><script src="/assets/js/26.593cdeff.js" defer></script><script src="/assets/js/app.7ba35480.js" defer></script>
  </body>
</html>
